<!doctype html>
<html lang="en" data-bs-theme="dark" class="theme-darkblue">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OSINT Tool Web</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
      .theme-darkblue {
        color-scheme: dark;
        --bg: #0b1220;           /* near-black with blue tint */
        --surface: #0f172a;      /* deep slate/blue */
        --border: #1b2a4a;       /* dark blue border */
        --text: #e5ecff;         /* soft ice blue */
        --muted: #9bb0d6;        /* desaturated blue */
        --primary: #3b82f6;      /* blue-500 */
        --primary-600: #2563eb;  /* blue-600 */
        --success: #10b981;      /* emerald */
        --warning: #f59e0b;      /* amber */
        --danger: #ef4444;       /* red */
      }

      .theme-darkblue body, .theme-darkblue .bg-body, .theme-darkblue .bg-body-tertiary { background-color: var(--bg) !important; color: var(--text); }
      .theme-darkblue .border, .theme-darkblue .border-top, .theme-darkblue .border-bottom, .theme-darkblue .border-start, .theme-darkblue .border-end { border-color: var(--border) !important; }
      .theme-darkblue .navbar, .theme-darkblue .tab-content { background-color: var(--surface) !important; }
      .theme-darkblue .nav-tabs .nav-link { color: var(--muted); border-color: var(--border); background: transparent; }
      .theme-darkblue .nav-tabs .nav-link.active { color: var(--text); background-color: rgba(59,130,246,0.08); border-color: var(--border) var(--border) transparent; }
      .theme-darkblue .tab-content { border-color: var(--border) !important; }

      .theme-darkblue .card { background-color: var(--surface); border: 1px solid var(--border); }
      .theme-darkblue .card-title { color: var(--text); }

      .theme-darkblue .table { color: var(--text); }
      .theme-darkblue .table td, .theme-darkblue .table th { border-color: var(--border) !important; }

      .theme-darkblue .form-control { background-color: #0b1220; border-color: var(--border); color: var(--text); }
      .theme-darkblue .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 .2rem rgba(59,130,246,.15); }
      .theme-darkblue .form-check-input { background-color: #0b1220; border-color: var(--border); }
      .theme-darkblue .form-check-input:checked { background-color: var(--primary); border-color: var(--primary); }

      .theme-darkblue .btn-primary { background-color: var(--primary); border-color: var(--primary-600); }
      .theme-darkblue .btn-primary:hover { background-color: var(--primary-600); border-color: var(--primary-600); }
      .theme-darkblue a, .theme-darkblue .link-primary { color: var(--primary); }

      .theme-darkblue .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
      .theme-darkblue .muted { color: var(--muted); }
      .theme-darkblue .avatar { width: 48px; height: 48px; border-radius: 50%; border: 1px solid rgba(255,255,255,.15); }
      .theme-darkblue .small { font-size: 12px; }
      .theme-darkblue .kv { list-style: none; margin: 0; padding: 0; }
      .theme-darkblue .kv li { display: flex; justify-content: space-between; gap: .75rem; padding: .25rem 0; border-bottom: 1px dashed var(--border); }
      .theme-darkblue .kv li:last-child { border-bottom: 0; }
      .theme-darkblue .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
      .theme-darkblue .badge-pill { border-radius: 50rem; padding: .35em .7em; font-weight: 600; }

      .theme-darkblue .text-bg-success { background-color: color-mix(in oklab, var(--success) 30%, black) !important; color: #d1fae5 !important; }
      .theme-darkblue .text-bg-warning { background-color: color-mix(in oklab, var(--warning) 25%, black) !important; color: #fff7ed !important; }
      .theme-darkblue .text-bg-danger { background-color: color-mix(in oklab, var(--danger) 25%, black) !important; color: #ffe4e6 !important; }
      .theme-darkblue .text-bg-secondary { background-color: #111827 !important; color: #cfd8ff !important; }

      /* ASCII logo styling */
      .ascii-logo { 
        line-height: 1.05; 
        font-size: 13px; 
        color: var(--primary); 
        background: transparent; 
        border: 1px dashed var(--border); 
        border-radius: 8px; 
        padding: 12px; 
        overflow: auto;
        user-select: text;
      }
      @media (min-width: 768px) { .ascii-logo { font-size: 15px; } }
    </style>
  </head>
  <body class="bg-body-tertiary">
    <nav class="navbar navbar-expand-lg bg-body border-bottom">
      <div class="container">
        <a class="navbar-brand fw-semibold" href="#">OSINT Tool</a>
        <div class="ms-auto d-flex align-items-center gap-3">
          <span class="badge text-bg-secondary">Web UI</span>
          <div class="form-check form-switch mb-0">
            <input class="form-check-input" type="checkbox" id="themeToggle" checked>
            <label class="form-check-label small" for="themeToggle">Dark</label>
          </div>
        </div>
      </div>
    </nav>
    <main class="container my-4">
      <div class="mb-3">
        <pre class="mono ascii-logo">  ___  ____  ___ _   _ _____    _____           _ 
 / _ \|  _ \|_ _| \ | |_   _|  |_   _|__   ___ | |
| | | | |_) || ||  \| | | |_____| |/ _ \ / _ \| |
| |_| |  _ < | || . ` | | |_____| | (_) | (_) | |
 \___/|_| \_\___|_|\__| |_|     |_|\___/ \___/|_|
           OSINT Tool
        </pre>
      </div>
      <ul class="nav nav-tabs" id="osintTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tab-domain" data-bs-toggle="tab" data-bs-target="#pane-domain" type="button" role="tab">Domain</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-ip" data-bs-toggle="tab" data-bs-target="#pane-ip" type="button" role="tab">IP</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-username" data-bs-toggle="tab" data-bs-target="#pane-username" type="button" role="tab">Username</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-email" data-bs-toggle="tab" data-bs-target="#pane-email" type="button" role="tab">Email</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-github" data-bs-toggle="tab" data-bs-target="#pane-github" type="button" role="tab">GitHub</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-subdomains" data-bs-toggle="tab" data-bs-target="#pane-subdomains" type="button" role="tab">Subdomains</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-ai" data-bs-toggle="tab" data-bs-target="#pane-ai" type="button" role="tab">AI</button>
        </li>
      </ul>

      <div class="tab-content border border-top-0 bg-body rounded-bottom p-3">
        <div class="tab-pane fade show active" id="pane-domain" role="tabpanel">
          <div class="row g-3 align-items-end">
            <div class="col-sm-4">
              <label class="form-label">Domain</label>
              <input class="form-control" id="domain" placeholder="example.com" />
            </div>
            <div class="col-sm-6">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="d_whois" checked>
                <label class="form-check-label" for="d_whois">WHOIS</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="d_dns" checked>
                <label class="form-check-label" for="d_dns">DNS</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="d_subs">
                <label class="form-check-label" for="d_subs">Subdomains</label>
              </div>
            </div>
            <div class="col-sm-2 text-end">
              <button class="btn btn-primary w-100" onclick="runDomain()">Run</button>
            </div>
          </div>
          <div class="mt-3" id="domain_out"></div>
        </div>

        <div class="tab-pane fade" id="pane-ip" role="tabpanel">
          <div class="row g-3 align-items-end">
            <div class="col-sm-4">
              <label class="form-label">IP</label>
              <input class="form-control" id="ip" placeholder="8.8.8.8" />
            </div>
            <div class="col-sm-6">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="i_details" checked>
                <label class="form-check-label" for="i_details">Details</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="i_reverse" checked>
                <label class="form-check-label" for="i_reverse">Reverse</label>
              </div>
            </div>
            <div class="col-sm-2 text-end">
              <button class="btn btn-primary w-100" onclick="runIP()">Run</button>
            </div>
          </div>
          <div class="mt-3" id="ip_out"></div>
        </div>

        <div class="tab-pane fade" id="pane-username" role="tabpanel">
          <div class="row g-3 align-items-end">
            <div class="col-sm-6">
              <label class="form-label">Username</label>
              <input class="form-control" id="username" placeholder="johndoe" />
            </div>
            <div class="col-sm-2 text-end">
              <button class="btn btn-primary w-100" onclick="runUsername()">Run</button>
            </div>
          </div>
          <div class="mt-3" id="user_out"></div>
        </div>

        <div class="tab-pane fade" id="pane-email" role="tabpanel">
          <div class="row g-3 align-items-end">
            <div class="col-sm-6">
              <label class="form-label">Email</label>
              <input class="form-control" id="email" placeholder="someone@example.com" />
            </div>
            <div class="col-sm-2 text-end">
              <button class="btn btn-primary w-100" onclick="runEmail()">Run</button>
            </div>
          </div>
          <div class="mt-3" id="email_out"></div>
        </div>

        <div class="tab-pane fade" id="pane-github" role="tabpanel">
          <div class="row g-3 align-items-end">
            <div class="col-sm-6">
              <label class="form-label">GitHub User</label>
              <input class="form-control" id="ghuser" placeholder="torvalds" />
            </div>
            <div class="col-sm-2 text-end">
              <button class="btn btn-primary w-100" onclick="runGitHub()">Run</button>
            </div>
          </div>
          <div class="mt-3" id="gh_out"></div>
        </div>

        <div class="tab-pane fade" id="pane-subdomains" role="tabpanel">
          <div class="row g-3 align-items-end">
            <div class="col-sm-6">
              <label class="form-label">Domain</label>
              <input class="form-control" id="subs_domain" placeholder="example.com" />
            </div>
            <div class="col-sm-3">
              <label class="form-label">Limit</label>
              <input class="form-control" id="subs_limit" type="number" value="200" />
            </div>
            <div class="col-sm-2 form-check align-self-center mt-4">
              <input class="form-check-input" type="checkbox" id="subs_resolve">
              <label class="form-check-label" for="subs_resolve">Resolve A records</label>
            </div>
            <div class="col-sm-1 text-end">
              <button class="btn btn-primary w-100" onclick="runSubdomains()">Run</button>
            </div>
          </div>
          <div class="mt-3" id="subs_out"></div>
        </div>

        <div class="tab-pane fade" id="pane-ai" role="tabpanel">
          <div class="row g-3 align-items-end">
            <div class="col-sm-4">
              <label class="form-label">Target</label>
              <input class="form-control" id="ai_target" placeholder="example.com or 8.8.8.8 or user" />
            </div>
            <div class="col-sm-4">
              <label class="form-label">Kind</label>
              <select class="form-select" id="ai_kind">
                <option value="domain">domain</option>
                <option value="ip">ip</option>
                <option value="username">username</option>
                <option value="email">email</option>
                <option value="github">github</option>
              </select>
            </div>
            <div class="col-sm-2">
              <label class="form-label">OpenAI API Key</label>
              <input class="form-control" id="ai_key" placeholder="sk-..." />
            </div>
            <div class="col-sm-2 text-end">
              <button class="btn btn-primary w-100" onclick="runAISummarize()">Summarize</button>
            </div>
          </div>
          <div class="mt-3" id="ai_summary"></div>

          <div class="row g-3 align-items-end mt-3">
            <div class="col-sm-8">
              <label class="form-label">Ask a question (about the summary/context)</label>
              <input class="form-control" id="ai_question" placeholder="What stands out?" />
            </div>
            <div class="col-sm-2 text-end">
              <button class="btn btn-secondary w-100" onclick="runAIAsk()">Ask</button>
            </div>
          </div>
          <div class="mt-3" id="ai_answer"></div>
        </div>
      </div>
    </main>
    <footer class="border-top py-3 small text-center text-secondary">OSINT Tool • Local-only demo UI</footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
      async function postJSON(url, body) {
        const r = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
        if (!r.ok) {
          let msg = `${r.status} ${r.statusText}`;
          try {
            const j = await r.json();
            if (j && j.detail) msg = `${msg}: ${j.detail}`;
          } catch {}
          throw new Error(msg);
        }
        return r.json();
      }
      // Theme toggle
      function applyTheme(theme) {
        const html = document.documentElement;
        if (theme === 'dark') {
          html.setAttribute('data-bs-theme', 'dark');
          html.classList.add('theme-darkblue');
        } else {
          html.setAttribute('data-bs-theme', 'light');
          html.classList.remove('theme-darkblue');
        }
        localStorage.setItem('theme', theme);
        const toggle = document.getElementById('themeToggle');
        if (toggle) toggle.checked = theme === 'dark';
      }
      (function(){
        const saved = localStorage.getItem('theme') || 'dark';
        applyTheme(saved);
        document.addEventListener('DOMContentLoaded', () => {
          const toggle = document.getElementById('themeToggle');
          if (toggle) toggle.addEventListener('change', (e) => {
            applyTheme(e.target.checked ? 'dark' : 'light');
          });
        });
      })();

      const el = (id) => document.getElementById(id);
      const esc = (s) => String(s ?? '').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));

      function renderKVCard(title, obj, keys) {
        const items = keys
          .map(k => `<li><span class="muted">${esc(k)}</span><span class="mono">${esc(obj?.[k]) || '<span class="muted">—</span>'}</span></li>`) 
          .join('');
        return `<div class="card"><div class="card-body"><h5 class="card-title">${esc(title)}</h5><ul class="kv">${items}</ul></div></div>`;
      }

      function renderListCard(title, list) {
        const items = (list ?? []).map(v => `<li class="mono">${esc(v)}</li>`).join('');
        return `<div class="card"><div class="card-body"><h5 class="card-title">${esc(title)}</h5><ul class="kv">${items || '<li class="muted">(none)</li>'}</ul></div></div>`;
      }

      function renderDNS(dns) {
        if (!dns) return '<div class="muted small">No DNS data</div>';
        const parts = Object.entries(dns).map(([rtype, values]) => renderListCard(`DNS ${rtype}`, values));
        return `<div class="grid">${parts.join('')}</div>`;
      }

      function badge(status) {
        if (status === 'exists') return '<span class="badge rounded-pill text-bg-success">exists</span>';
        if (status === 'not found') return '<span class="badge rounded-pill text-bg-danger">not found</span>';
        if (status === 'maybe') return '<span class="badge rounded-pill text-bg-warning">maybe</span>';
        if (status === 'rate limited') return '<span class="badge rounded-pill text-bg-warning">rate limited</span>';
        if (status === 'timeout') return '<span class="badge rounded-pill text-bg-warning">timeout</span>';
        return `<span class="badge rounded-pill text-bg-secondary">${esc(status)}</span>`;
      }

      function renderTable(headers, rows) {
        const head = `<tr>${headers.map(h=>`<th>${esc(h)}</th>`).join('')}</tr>`;
        const body = rows.map(r => `<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('');
        return `<div class="table-responsive"><table class="table table-sm">${head}${body}</table></div>`;
      }
      async function runDomain(){
        const domain = document.getElementById('domain').value.trim();
        const whois = document.getElementById('d_whois').checked;
        const dns = document.getElementById('d_dns').checked;
        const subs = document.getElementById('d_subs').checked;
        el('domain_out').innerHTML = '<div class="text-secondary small">Loading…</div>';
        try {
          const data = await postJSON('/api/domain', {domain, whois, dns, subdomains: subs});
          const whoisCard = whois ? renderKVCard('WHOIS summary', data.whois || {}, ['domain_name','registrar','creation_date','expiration_date','updated_date']) : '';
          const dnsCards = dns ? renderDNS(data.dns) : '';
          const subsCard = subs ? renderListCard(`Subdomains (${(data.subdomains||[]).length})`, data.subdomains) : '';
          el('domain_out').innerHTML = `<div class="grid">${whoisCard}${subsCard}</div>${dnsCards}`;
        } catch(e) {
          el('domain_out').innerHTML = `<div class="alert alert-danger" role="alert">${esc(e.message)}</div>`;
        }
      }
      async function runIP(){
        const ip = document.getElementById('ip').value.trim();
        const details = document.getElementById('i_details').checked;
        const reverse = document.getElementById('i_reverse').checked;
        el('ip_out').innerHTML = '<div class="text-secondary small">Loading…</div>';
        try {
          const data = await postJSON('/api/ip', {ip, details, reverse});
          const ptrCard = renderKVCard('Reverse DNS', {ptr: data.ptr || '—'}, ['ptr']);
          let infoGrid = '';
          if (details && data.details) {
            const ipinfo = data.details.ipinfo || {};
            const ipapi = data.details.ipapi || {};
            const ipinfoCard = renderKVCard('ipinfo.io', ipinfo, ['ip','org','city','region','country','loc','hostname']);
            const ipapiCard = renderKVCard('ip-api.com', ipapi, ['country','regionName','city','isp','org','as','reverse','proxy','hosting']);
            infoGrid = `<div class="grid">${ipinfoCard}${ipapiCard}</div>`;
          }
          el('ip_out').innerHTML = `<div class="grid">${ptrCard}</div>${infoGrid}`;
        } catch(e) {
          el('ip_out').innerHTML = `<div class="alert alert-danger" role="alert">${esc(e.message)}</div>`;
        }
      }
      async function runUsername(){
        const username = document.getElementById('username').value.trim();
        el('user_out').innerHTML = '<div class="text-secondary small">Loading…</div>';
        try {
          const data = await postJSON('/api/username', {username});
          const rows = (data.results||[]).sort((a,b)=>a.site.localeCompare(b.site)).map(i => [
            esc(i.site),
            badge(i.status),
            i.url ? `<a href="${esc(i.url)}" target="_blank" rel="noreferrer">link</a>` : '<span class="muted">—</span>'
          ]);
          el('user_out').innerHTML = renderTable(['Site','Status','URL'], rows);
        } catch(e) {
          el('user_out').innerHTML = `<div class="alert alert-danger" role="alert">${esc(e.message)}</div>`;
        }
      }
      async function runEmail(){
        const address = document.getElementById('email').value.trim();
        el('email_out').innerHTML = '<div class="text-secondary small">Loading…</div>';
        try {
          const data = await postJSON('/api/email', {address});
          const valid = data.valid_syntax ? '<span class="badge ok">valid</span>' : '<span class="badge err">invalid</span>';
          const grav = data.gravatar?.exists ? `<img class="avatar" src="${esc(data.gravatar.url)}" alt="gravatar" />` : '<span class="muted">no gravatar</span>';
          el('email_out').innerHTML = `
            <div class="grid">
              <div class="card"><div class="card-body">
                <h5 class="card-title">Email</h5>
                <div class="d-flex align-items-center gap-2"><div class="mono">${esc(data.address)}</div><div>${valid}</div></div>
              </div></div>
              <div class="card"><div class="card-body"><h5 class="card-title">Gravatar</h5><div class="d-flex align-items-center gap-2">${grav}</div></div></div>
            </div>`;
        } catch(e) {
          el('email_out').innerHTML = `<div class="alert alert-danger" role="alert">${esc(e.message)}</div>`;
        }
      }
      async function runGitHub(){
        const user = document.getElementById('ghuser').value.trim();
        el('gh_out').innerHTML = '<div class="text-secondary small">Loading…</div>';
        try {
          const data = await postJSON('/api/github', {user});
          const u = data.user || {};
          const profile = u.user || u; // endpoint returns { user: user, repos: [...] }
          const profileCard = `
            <div class="card"><div class="card-body">
              <h5 class="card-title">Profile</h5>
              <div class="kv">
                <div class="d-flex align-items-center gap-3">
                  ${profile.avatar_url ? `<img class="avatar" src="${esc(profile.avatar_url)}" alt="avatar" />` : ''}
                  <div>
                    <div class="fw-semibold">${esc(profile.name || '')} <span class="text-secondary">@${esc(profile.login || '')}</span></div>
                    <div class="small text-secondary">${esc(profile.bio || '')}</div>
                  </div>
                </div>
                <ul class="kv mt-2">
                  <li><span class="muted">Company</span><span class="mono">${esc(profile.company || '—')}</span></li>
                  <li><span class="muted">Location</span><span class="mono">${esc(profile.location || '—')}</span></li>
                  <li><span class="muted">Blog</span><span class="mono">${profile.blog ? `<a href="${esc(profile.blog)}" target="_blank" rel="noreferrer">${esc(profile.blog)}</a>` : '—'}</span></li>
                  <li><span class="muted">Followers</span><span class="mono">${esc(profile.followers ?? '—')}</span></li>
                  <li><span class="muted">Following</span><span class="mono">${esc(profile.following ?? '—')}</span></li>
                  <li><span class="muted">Public Repos</span><span class="mono">${esc(profile.public_repos ?? '—')}</span></li>
                </ul>
              </div>
            </div></div>`;
          const repos = (data.repos || u.repos || []).slice(0, 20);
          const rows = repos.map(r => [
            r.name ? `<a href="https://github.com/${esc(profile.login)}/${esc(r.name)}" target="_blank" rel="noreferrer">${esc(r.name)}</a>` : '—',
            esc(r.language || '—'),
            esc(r.stargazers_count ?? '0'),
            esc(r.updated_at || '—')
          ]);
          const reposTable = `<div class="card"><div class="card-body"><h5 class="card-title">Repositories</h5>${renderTable(['Name','Lang','★','Updated'], rows)}</div></div>`;
          el('gh_out').innerHTML = `<div class="grid">${profileCard}${reposTable}</div>`;
        } catch(e) {
          el('gh_out').innerHTML = `<div class="alert alert-danger" role="alert">${esc(e.message)}</div>`;
        }
      }

      async function runSubdomains(){
        const domain = el('subs_domain').value.trim();
        const limit = parseInt(el('subs_limit').value || '200', 10);
        const resolve = el('subs_resolve').checked;
        el('subs_out').innerHTML = '<div class="text-secondary small">Enumerating…</div>';
        try {
          const data = await postJSON('/api/subdomains', { domain, limit, resolve });
          if (!resolve) {
            const rows = (data.subdomains||[]).map(h => [ `<span class="mono">${esc(h)}</span>` ]);
            el('subs_out').innerHTML = renderTable(['Host'], rows);
          } else {
            const rows = (data.results||[]).map(r => [ `<span class="mono">${esc(r.host)}</span>`, `<span class="mono">${esc((r.ips||[]).join(', ')||'—')}</span>` ]);
            el('subs_out').innerHTML = renderTable(['Host','A records'], rows);
          }
        } catch(e) {
          el('subs_out').innerHTML = `<div class="alert alert-danger" role="alert">${esc(e.message)}</div>`;
        }
      }

      function renderMarkdown(md) {
        // Minimal markdown to HTML (headings + bullets). Keep it simple to avoid extra deps.
        const esc = (s) => String(s ?? '').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
        return esc(md)
          .replace(/^### (.*)$/gm, '<h5>$1</h5>')
          .replace(/^## (.*)$/gm, '<h4>$1</h4>')
          .replace(/^# (.*)$/gm, '<h3>$1</h3>')
          .replace(/^\- (.*)$/gm, '<li>$1</li>')
          .replace(/\n<li>/g, '<ul class="mb-2"><li>')
          .replace(/<li>(.*)\n(?!<li>)/g, '<li>$1</li></ul>');
      }

      async function runAISummarize(){
        const target = el('ai_target').value.trim();
        const kind = el('ai_kind').value;
        const api_key = el('ai_key').value.trim() || undefined;
        el('ai_summary').innerHTML = '<div class="text-secondary small">Thinking…</div>';
        try {
          const data = await postJSON('/api/ai/summarize', { target, kind, api_key });
          const html = renderMarkdown(data.summary_md || '');
          el('ai_summary').innerHTML = `<div class="card"><div class="card-body">${html}</div></div>`;
        } catch(e) {
          el('ai_summary').innerHTML = `<div class="alert alert-danger" role="alert">${esc(e.message)}</div>`;
        }
      }

      async function runAIAsk(){
        const q = el('ai_question').value.trim();
        const target = el('ai_target').value.trim();
        const kind = el('ai_kind').value;
        const api_key = el('ai_key').value.trim() || undefined;
        el('ai_answer').innerHTML = '<div class="text-secondary small">Thinking…</div>';
        try {
          // Ask with fresh lightweight context to avoid stale state
          const ctx = await (await fetch('/api/ai/summarize', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ target, kind, max_tokens: 200, api_key }) })).json();
          const data = await postJSON('/api/ai/ask', { question: q, context: ctx.context, max_tokens: 250, api_key });
          el('ai_answer').innerHTML = `<div class="card"><div class="card-body">${renderMarkdown(data.answer_md || '')}</div></div>`;
        } catch(e) {
          el('ai_answer').innerHTML = `<div class="alert alert-danger" role="alert">${esc(e.message)}</div>`;
        }
      }
    </script>
  </body>
  </html>


